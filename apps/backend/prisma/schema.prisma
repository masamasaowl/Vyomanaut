// Prisma Schema for Vyomanaut
// This is our source of truth for the database structure

// Contains 7 models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// DEVICE MANAGEMENT
// ========================================

enum DeviceStatus {
  ONLINE
  OFFLINE
  SUSPENDED // User paused earning, or we detected issues
}

enum DeviceType {
  ANDROID
  IOS
  DESKTOP
  MACOS
  LINUX
}


// ================== Device ==================
// Tracks each contributor's device
model Device {

  // As soon as you register 
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Device Identification
  deviceId     String     @unique // From mobile app (Android ID, etc.)
  deviceType   DeviceType

  // Device Specs
  totalStorageBytes     BigInt // How much they allocated
  availableStorageBytes BigInt // Currently free
  
  // The Whatsapp check
  status        DeviceStatus @default(OFFLINE)
  lastSeenAt    DateTime     @default(now())
  ipAddress     String?
  

  // Their performance
  // 0-100, decreases with downtime
  reliabilityScore Float   @default(100.0) 
  // in Milliseconds
  totalUptime      BigInt  @default(0) 
  totalDowntime    BigInt  @default(0)


  // Where is my chunk (one to many)
  chunks ChunkLocation[]


  // Payment tracking
  // Do they earn, how much? 
  totalEarnings       Decimal @default(0) @db.Decimal(10, 6)

  // When did we last pay them
  lastPaymentAt       DateTime?
  // How much do we have left to pay
  pendingEarnings     Decimal @default(0) @db.Decimal(10, 6)


  // The entire Earning history of the device
  earningHistory      EarningRecord[]


  // Who is your user?
  // Connect to users table
  // User gone -> all his devices gone
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  

  // Speed up the query
  @@index([status])
  @@index([reliabilityScore])
}


// ========================================
// FILE MANAGEMENT
// ========================================

enum FileStatus {
  UPLOADING    // Currently being chunked and distributed
  ACTIVE       // Fully replicated and available
  DEGRADED     // Some chunks lost, below redundancy target
  DELETED      // Marked for deletion
}


// ================== File ==================
model File {

  // Did you upload your file
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // File Information
  originalName String
  mimeType     String
  sizeBytes    BigInt

  
  // Encryption
  encryptionKey String // Wrapped DEK (safe to store!)
  dekId         String // DEK identifier
  checksum      String // SHA-256 of original file
  
  // What we did with your file
  status       FileStatus @default(UPLOADING)
  // How many chunks
  chunkCount   Int
  
  // All the chunks (one to many: one file many chunks)
  chunks Chunk[]


  // Ownership, Who uploaded this?
  // Connect to company info table
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@index([status])
}


// ========================================
// CHUNK MANAGEMENT
// ========================================

enum ChunkStatus {
  PENDING      // Created but not yet distributed
  REPLICATING  // Being copied to devices
  HEALTHY      // Has >= redundancy factor copies
  DEGRADED     // Below redundancy factor
  LOST         // All copies gone (The most critical error possible)
}


// ================== Chunk ==================
model Chunk {

  // When we create a single chunk
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Identify the chunk
  fileId       String
  sequenceNum  Int    // 0, 1, 2... for reassembly order
  sizeBytes    Int
  // No tampering assured
  checksum     String // SHA-256 for integrity check
  
  // Encryption metadata (needed to decrypt)
  iv           String // Hex-encoded IV
  authTag      String // Hex-encoded auth tag
  aad          String // Hex-encoded AAD
  
  // How is it doing
  status          ChunkStatus @default(PENDING)
  // How many copies exist 
  currentReplicas Int         @default(0)
  targetReplicas  Int         @default(3)
  
  // Relations
  // Who are you a chunk of
  file      File            @relation(fields: [fileId], references: [id], onDelete: Cascade)

  // Which device are you stored on
  locations ChunkLocation[]
  
  @@unique([fileId, sequenceNum])
  @@index([status])
  @@index([fileId])
}

// ========================================
// CHUNK-DEVICE MAPPING (The Critical Registry!)
// ========================================


// ================== ChunkLocation =================
model ChunkLocation {

  // So our little chunk went somewhere
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Who was that chunk
  chunkId  String
  // And where is that chunk
  deviceId String
  
  // Where are you stored inside the device
  localPath String // e.g., "/storage/chunks/abc123.enc"
  
  // Verification
  lastVerified DateTime? // When we last confirmed chunky existed
  // Is he doing good
  isHealthy    Boolean   @default(true)
  

  // Payment tracking for each chunk
  lastEarningsUpdate  DateTime @default(now())
  totalEarnings       Decimal  @default(0) @db.Decimal(10, 6)


  // Relations
  // Where did you come from
  chunk  Chunk  @relation(fields: [chunkId], references: [id], onDelete: Cascade)
  
  // Where did you go
  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  
  @@unique([chunkId, deviceId]) // A chunk can only be on a device once
  @@index([deviceId])
  @@index([chunkId])
}


// ========================================
// USER AUTHENTICATION
// ========================================

// The three roles interacting with our app
enum UserRole {
  USER        // Mobile app users
  COMPANY     // Business customers
  ADMIN       // Platform administrators
}

// How we verify them
// Better than boolean as allows moderation
enum VerificationStatus {
  PENDING
  VERIFIED
  SUSPENDED
}

// ================ User (Explorer) ==================
model User {

  // Let's get to know each other
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Authentication storage
  email           String   @unique
  password        String   // Bcrypt hashed
  role            UserRole @default(USER)
  
  // Profile
  name            String?
  phone           String?
  
  // Verification (additional steps)
  emailVerified   Boolean  @default(false)
  verificationToken String?
  status          VerificationStatus @default(PENDING)
  
  // To help resetting passwords
  resetToken      String?
  resetExpiry     DateTime?
  
  // One user can have multiple devices for himself 
  // Relationship -> one to many 
  devices         Device[]  
  

  // Earnings Summary 
  // It is denormalized for quick access
  // ( Field exists in Device Model also )
  totalEarnings   Decimal  @default(0) @db.Decimal(10, 6)
  
  @@index([email])
}


// =============== Company (Enterprise) ==============
model Company {

  // Let's get you registered
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Authentication
  email           String   @unique
  password        String   // Bcrypt hashed
  role            UserRole @default(COMPANY)
  
  // Your Info
  name            String
  website         String?
  industry        String?

  // Verification
  emailVerified   Boolean  @default(false)
  verificationToken String?
  status          VerificationStatus @default(PENDING)
  
  // Password Reset
  resetToken      String?
  resetExpiry     DateTime?
  
  
  // * API Access *
  // Companies might never register and access the service directly via APIs
  apiKey          String   @unique @default(cuid())
  // Hashed API secret for programmatic access
  apiSecretHash   String?  

  
  // Subscription (for future operations)
  // ex: free, starter, business, enterprise
  plan            String   @default("free") 
   // 10GB default
  storageLimit    BigInt   @default(10737418240)
  

  // Relationships
  // One to many
  // Files uploaded by this company
  files           File[]   
  

  // Usage Stats (denormalized for quick access)
  totalStorageUsed BigInt  @default(0)
  filesUploaded    Int     @default(0)
  
  @@index([email])
  @@index([apiKey])
}


// ================== Admin (Staff) ==================
model Admin {

  // He's our guy
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Authentication
  email           String   @unique
  password        String   // Bcrypt hashed
  role            UserRole @default(ADMIN)
  
  // Admin Info
  name            String

  // The Admin is not a boolean 
  // This would provide us greater control over which action needs to be performed if we scale drastically
  // ["users.manage", "companies.manage", "system.config"]
  permissions     String[] 
  
  // Security 
  // 1. Track Logging
  lastLoginAt     DateTime?
  lastLoginIP     String?

  // 2. Two factor authentication
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?
  

  @@index([email])
}


// ================== RefreshToken ==================
model RefreshToken {

  // This token would be used to revive our JWT
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  
  // Store token value
  token       String   @unique
  
  // Who does this token belong to?
  // This one table works for all the user roles, helping us not creating multiple tables
  // USER, COMPANY, or ADMIN
  userType    UserRole 
  // ID of User, Company, or Admin
  userId      String   
  
  // Security tracking
  // If revoked then we log out of all the devices the User had registered from
  isRevoked   Boolean  @default(false)
  ipAddress   String?
  // Which browser created the session
  userAgent   String?
  
  @@index([token])
  @@index([userId, userType])
}



// ========================================
// ANALYTICS & MONITORING
// ========================================

// ================== DeviceMetric ==================
model DeviceMetric {
  // How is the device doing
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Which device is it again
  deviceId String
  
  // Snapshot metrics (recorded every hour)
  // You are being watched
  storageUsedBytes BigInt
  chunksStored     Int
  uptime           Boolean
  
  @@index([deviceId, createdAt])
}



// ================== SystemMetric ==================

model SystemMetric {
  // How are we doing (Per Server)
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Platform-wide metrics
  // How many devices registered
  totalDevices       Int
  // How many are up
  devicesOnline      Int
  // How much can we hold in
  totalStorageBytes  BigInt
  // How much divisions are stored
  totalChunks        Int
  // How many files do we store
  totalFiles         Int
  
  @@index([createdAt])
}



// ================== Payments Gateway ===============
model EarningRecord {

  // You'll be paid, but first let us know who you are
  id                  String   @id @default(cuid())
  createdAt           DateTime @default(now())
  

  // We track you through your device
  deviceId            String
  device              Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)


  // We track the earnings for a specific period
  // Currently it is for a month, and then pay all the contributors 
  // Format: "2024-12" for December 2024
  // This replaces createdAt() query
  period              String  
   
  // GB stored in this period
  storageGB           Float    
  // Hours online in this period
  hoursOnline         Float    


  // It's time to bring out those calculators 
  // This is the final sum you earned in this period
  earned              Decimal  @db.Decimal(10, 6)

  @@index([deviceId, period])
}

